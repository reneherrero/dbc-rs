name: dbc-rs Library CI

on:
  push:
    branches: [ main ]
    paths:
      - 'dbc/**'
      - '.github/workflows/dbc-rs.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'dbc/**'
      - '.github/workflows/dbc-rs.yml'

env:
  CARGO_TERM_COLOR: always
  MSRV: "1.85.0"

jobs:
  test-std:
    name: Test (std, latest)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust toolchain (stable)
        uses: dtolnay/rust-toolchain@stable
      - name: Build library with std feature
        run: cargo build --verbose -p dbc-rs
      - name: Run tests with std feature
        run: cargo test --verbose -p dbc-rs

  test-no-std:
    name: Test (no_std, latest)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust toolchain (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          target: thumbv7m-none-eabi
      - name: Build library without std (no_std mode)
        run: cargo build --verbose --no-default-features --target thumbv7m-none-eabi -p dbc-rs


  test-std-msrv:
    name: Test (std, MSRV)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust toolchain (MSRV 1.85.0)
        uses: dtolnay/rust-toolchain@1.85.0
      - name: Build library with std feature (MSRV)
        run: cargo build --verbose -p dbc-rs
      - name: Run tests with std feature (MSRV)
        run: cargo test --verbose -p dbc-rs

  test-no-std-msrv:
    name: Test (no_std, MSRV)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust toolchain (MSRV 1.85.0)
        uses: dtolnay/rust-toolchain@1.85.0
        with:
          target: thumbv7m-none-eabi
      - name: Build library without std (no_std mode, MSRV)
        run: cargo build --verbose --no-default-features --target thumbv7m-none-eabi -p dbc-rs

  lint:
    name: Lint (clippy)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust toolchain with clippy
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - name: Run clippy linter
        run: cargo clippy --verbose -p dbc-rs -- -D warnings

  fmt:
    name: Format check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust toolchain with rustfmt
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Check code formatting
        run: cargo fmt --verbose -- --check

  doc:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust toolchain (stable)
        uses: dtolnay/rust-toolchain@stable
      - name: Check documentation (public API)
        env:
          RUSTDOCFLAGS: "-D warnings"
        run: cargo doc --no-deps -p dbc-rs
      - name: Check documentation (with private items)
        env:
          RUSTDOCFLAGS: "-D warnings"
        run: cargo doc --no-deps -p dbc-rs --document-private-items

  test-languages:
    name: Test language features
    runs-on: ubuntu-latest
    strategy:
      matrix:
        lang: [lang-fr, lang-es, lang-de, lang-ja]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust toolchain (stable)
        uses: dtolnay/rust-toolchain@stable
      - name: Build library with ${{ matrix.lang }} feature
        run: cargo build --verbose --features ${{ matrix.lang }} -p dbc-rs
      - name: Run tests with ${{ matrix.lang }} feature
        run: cargo test --verbose --features ${{ matrix.lang }} -p dbc-rs

