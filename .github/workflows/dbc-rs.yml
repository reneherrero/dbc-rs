name: dbc-rs Library CI

on:
  push:
    branches: [ main ]
    paths:
      - 'dbc/**'
      - '.github/workflows/dbc-rs.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'dbc/**'
      - '.github/workflows/dbc-rs.yml'

env:
  CARGO_TERM_COLOR: always
  MSRV: "1.85.0"

jobs:
  test-std:
    name: Test (std, latest)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust toolchain (stable)
        uses: dtolnay/rust-toolchain@stable
      - name: Build library with std feature
        run: cargo build --verbose -p dbc-rs
      - name: Run tests with std feature
        run: cargo test --verbose -p dbc-rs
      - name: Run workspace tests
        run: cargo test --verbose --workspace

  test-no-std:
    name: Test (no_std, latest)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust toolchain (stable)
        uses: dtolnay/rust-toolchain@stable
      - name: Install embedded target
        run: rustup target add thumbv7em-none-eabihf
      - name: Check library without std (no_std + alloc)
        run: cargo check --verbose --no-default-features --features alloc --target thumbv7em-none-eabihf -p dbc-rs
      - name: Build library without std (no_std + alloc, release)
        run: cargo build --release --verbose --no-default-features --features alloc --target thumbv7em-none-eabihf -p dbc-rs
      - name: Check library without std (no_std + heapless)
        env:
          DBC_MAX_MESSAGES: 500
        run: cargo check --verbose --no-default-features --features heapless --target thumbv7em-none-eabihf -p dbc-rs
      - name: Build library without std (no_std + heapless, release)
        env:
          DBC_MAX_MESSAGES: 500
        run: cargo build --release --verbose --no-default-features --features heapless --target thumbv7em-none-eabihf -p dbc-rs

  test-alloc:
    name: Test (alloc, latest)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust toolchain (stable)
        uses: dtolnay/rust-toolchain@stable
      - name: Test with alloc feature
        run: cargo test --verbose --no-default-features --features alloc -p dbc-rs
      - name: Build with alloc feature (release)
        run: cargo build --release --verbose --no-default-features --features alloc -p dbc-rs
      - name: Install embedded target
        run: rustup target add thumbv7em-none-eabihf
      - name: Build alloc on embedded target
        run: cargo build --release --verbose --no-default-features --features alloc --target thumbv7em-none-eabihf -p dbc-rs

  test-heapless:
    name: Test (heapless, latest)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust toolchain (stable)
        uses: dtolnay/rust-toolchain@stable
      - name: Test heapless feature (x86_64)
        env:
          RUST_MIN_STACK: 8388608
        run: cargo test --verbose --no-default-features --features heapless -p dbc-rs --lib
      - name: Build heapless (x86_64, release)
        env:
          DBC_MAX_MESSAGES: 500
        run: cargo build --release --verbose --no-default-features --features heapless -p dbc-rs
      - name: Install embedded target
        run: rustup target add thumbv7em-none-eabihf
      - name: Build heapless on embedded target
        env:
          DBC_MAX_MESSAGES: 500
        run: cargo build --release --verbose --no-default-features --features heapless --target thumbv7em-none-eabihf -p dbc-rs


  test-std-msrv:
    name: Test (std, MSRV)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust toolchain (MSRV 1.85.0)
        uses: dtolnay/rust-toolchain@1.85.0
      - name: Build library with std feature (MSRV)
        run: cargo build --verbose -p dbc-rs
      - name: Run tests with std feature (MSRV)
        run: cargo test --verbose --lib --tests -p dbc-rs

  test-no-std-msrv:
    name: Test (no_std, MSRV)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust toolchain (MSRV 1.85.0)
        uses: dtolnay/rust-toolchain@1.85.0
      - name: Install embedded target
        run: rustup target add thumbv7em-none-eabihf
      - name: Check library without std (no_std + alloc, MSRV)
        run: cargo check --verbose --no-default-features --features alloc --target thumbv7em-none-eabihf -p dbc-rs
      - name: Build library without std (no_std + alloc, MSRV, release)
        run: cargo build --release --verbose --no-default-features --features alloc --target thumbv7em-none-eabihf -p dbc-rs
      - name: Check library without std (no_std + heapless, MSRV)
        env:
          DBC_MAX_MESSAGES: 500
        run: cargo check --verbose --no-default-features --features heapless --target thumbv7em-none-eabihf -p dbc-rs
      - name: Build library without std (no_std + heapless, MSRV, release)
        env:
          DBC_MAX_MESSAGES: 500
        run: cargo build --release --verbose --no-default-features --features heapless --target thumbv7em-none-eabihf -p dbc-rs

  lint:
    name: Lint (clippy)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust toolchain (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - name: Install target standard library
        run: rustup target add thumbv7em-none-eabihf
      - name: Run clippy linter (std feature)
        run: rustup run stable cargo clippy --verbose --lib --bins -p dbc-rs -- -D warnings
      - name: Run clippy linter (alloc feature)
        run: rustup run stable cargo clippy --verbose --no-default-features --features alloc -p dbc-rs --lib --bins -- -D warnings
      - name: Run clippy linter (heapless x86_64)
        run: rustup run stable cargo clippy --verbose --no-default-features --features heapless -p dbc-rs --lib --bins -- -D warnings
      - name: Run clippy linter (heapless embedded)
        run: rustup run stable cargo clippy --verbose --no-default-features --features heapless --target thumbv7em-none-eabihf -p dbc-rs -- -D warnings
      - name: Run clippy linter (alloc embedded)
        run: rustup run stable cargo clippy --verbose --no-default-features --features alloc --target thumbv7em-none-eabihf -p dbc-rs -- -D warnings

  fmt:
    name: Format check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust toolchain (from rust-toolchain.toml)
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.85.0
          components: rustfmt
        # Uses MSRV (1.85.0) for consistent formatting across all developers
      - name: Check code formatting
        run: cargo fmt --verbose -- --check

  doc:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust toolchain (stable)
        uses: dtolnay/rust-toolchain@stable
      - name: Check documentation (public API)
        env:
          RUSTDOCFLAGS: "-D warnings"
        run: cargo doc --no-deps -p dbc-rs
      - name: Check documentation (with private items)
        env:
          RUSTDOCFLAGS: "-D warnings"
        run: cargo doc --no-deps -p dbc-rs

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust toolchain (stable)
        uses: dtolnay/rust-toolchain@stable
      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov
      - name: Generate code coverage
        run: |
          cargo llvm-cov \
            --workspace \
            --tests \
            --lib \
            --ignore-filename-regex "^(tests|examples|benches)/" \
            --fail-under-lines 80 \
            --lcov \
            --output-path coverage.lcov
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.lcov
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  benchmark:
    name: Benchmarks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust toolchain (stable)
        uses: dtolnay/rust-toolchain@stable
      - name: Run benchmarks in test mode
        run: cargo test --benches --verbose -p dbc-rs
      # Run actual benchmarks and save baseline for comparison
      - name: Run benchmarks and save baseline
        continue-on-error: true
        run: |
          # Save baseline with commit SHA for tracking
          BASELINE_NAME="ci-$(git rev-parse --short HEAD)"
          cargo bench --bench parse_bench --verbose -p dbc-rs -- --save-baseline "$BASELINE_NAME"
      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: criterion-results-${{ github.ref_name == 'main' && 'main' || format('commit-{0}', github.sha) }}
          path: |
            criterion/
            target/criterion/
          retention-days: 90


