name: dbc-rs Library CI

on:
  push:
    branches: [ main ]
    paths:
      - 'dbc/**'
      - '.github/workflows/dbc-rs.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'dbc/**'
      - '.github/workflows/dbc-rs.yml'

env:
  CARGO_TERM_COLOR: always
  MSRV: "1.85.0"

jobs:
  test-std:
    name: Test (std, latest)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust toolchain (stable)
        uses: dtolnay/rust-toolchain@stable
      - name: Build library with std feature
        run: cargo build --verbose -p dbc-rs
      - name: Run tests with std feature
        run: cargo test --verbose -p dbc-rs

  test-no-std:
    name: Test (no_std, latest)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust toolchain (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          target: thumbv7m-none-eabi
      - name: Install target standard library
        run: rustup target add thumbv7m-none-eabi
      - name: Check library without std (no_std mode)
        run: cargo check --verbose --no-default-features --target thumbv7m-none-eabi -p dbc-rs
      - name: Build library without std (no_std mode, release)
        run: cargo build --release --verbose --no-default-features --target thumbv7m-none-eabi -p dbc-rs


  test-std-msrv:
    name: Test (std, MSRV)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust toolchain (MSRV 1.85.0)
        uses: dtolnay/rust-toolchain@1.85.0
      - name: Build library with std feature (MSRV)
        run: cargo build --verbose -p dbc-rs
      - name: Run tests with std feature (MSRV)
        run: cargo test --verbose -p dbc-rs

  test-no-std-msrv:
    name: Test (no_std, MSRV)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust toolchain (MSRV 1.85.0)
        uses: dtolnay/rust-toolchain@1.85.0
        with:
          target: thumbv7m-none-eabi
      - name: Install target standard library
        run: rustup target add thumbv7m-none-eabi
      - name: Check library without std (no_std mode, MSRV)
        run: cargo check --verbose --no-default-features --target thumbv7m-none-eabi -p dbc-rs
      - name: Build library without std (no_std mode, MSRV, release)
        run: cargo build --release --verbose --no-default-features --target thumbv7m-none-eabi -p dbc-rs

  test-alloc:
    name: Test (alloc, latest)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust toolchain (stable)
        uses: dtolnay/rust-toolchain@stable
      - name: Build library with alloc feature
        run: cargo build --verbose --features alloc --no-default-features -p dbc-rs
      - name: Run tests with alloc feature
        run: cargo test --verbose --features alloc --no-default-features -p dbc-rs

  test-kernel:
    name: Test (kernel, latest)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust toolchain (stable)
        uses: dtolnay/rust-toolchain@stable
      - name: Build library with kernel feature
        run: cargo build --verbose --features kernel --no-default-features -p dbc-rs
      - name: Run tests with kernel feature
        run: cargo test --verbose --features kernel --no-default-features -p dbc-rs

  lint:
    name: Lint (clippy)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust toolchain (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - name: Run clippy linter (std feature)
        run: rustup run stable cargo clippy --verbose --all-targets -p dbc-rs -- -D warnings
      - name: Run clippy linter (no_std mode)
        run: rustup run stable cargo clippy --verbose --no-default-features --target thumbv7m-none-eabi -p dbc-rs -- -D warnings

  fmt:
    name: Format check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust toolchain (from rust-toolchain.toml)
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.85.0
          components: rustfmt
        # Uses MSRV (1.85.0) for consistent formatting across all developers
      - name: Check code formatting
        run: cargo fmt --verbose -- --check

  doc:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust toolchain (stable)
        uses: dtolnay/rust-toolchain@stable
      - name: Check documentation (public API)
        env:
          RUSTDOCFLAGS: "-D warnings"
        run: cargo doc --no-deps -p dbc-rs
      - name: Check documentation (with private items)
        env:
          RUSTDOCFLAGS: "-D warnings"
        run: cargo doc --no-deps -p dbc-rs

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust toolchain (stable)
        uses: dtolnay/rust-toolchain@stable
      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov
      - name: Generate code coverage
        run: |
          cargo llvm-cov \
            --workspace \
            --tests \
            --lib \
            --ignore-filename-regex "^(tests|examples|benches)/" \
            --fail-under-lines 80 \
            --lcov \
            --output-path coverage.lcov
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.lcov
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false


